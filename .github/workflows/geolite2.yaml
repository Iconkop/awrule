name: Auto Update GEO Data

on:
  schedule:
    - cron: '0 0 * * *'   # ÊØèÂ§© UTC 0:00ÔºàÂåó‰∫¨Êó∂Èó¥Êó©‰∏ä8ÁÇπÔºâ
  workflow_dispatch:       # ÊâãÂä®Ëß¶ÂèëÊîØÊåÅ

permissions:
  contents: write          # ‚úÖ ÂÖÅËÆ∏Êé®ÈÄÅÊõ¥Êñ∞

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
      ASN_URL: "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-ASN&license_key=${{ secrets.MAXMIND_LICENSE_KEY }}&suffix=tar.gz"
      META_BASE: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl tar

      # 1Ô∏è‚É£ ‰∏ãËΩΩ MetaCubeX geo Êï∞ÊçÆ
      - name: Download MetaCubeX GEO files
        run: |
          mkdir -p geo
          curl -L -o geo/geoip.dat     "${META_BASE}/geoip.dat"
          curl -L -o geo/geosite.dat   "${META_BASE}/geosite.dat"
          curl -L -o geo/country.mmdb  "${META_BASE}/country.mmdb"

      # 2Ô∏è‚É£ ‰∏ãËΩΩÂπ∂Ëß£Âéã MaxMind ASN
      - name: Download GeoLite2 ASN
        run: |
          echo "üì• Downloading GeoLite2-ASN..."
          curl -L -o GeoLite2-ASN.tar.gz "${ASN_URL}"
          tar -xzf GeoLite2-ASN.tar.gz
          FILE=$(find . -name "GeoLite2-ASN.mmdb" | head -n 1)
          if [ -f "$FILE" ]; then
            mv "$FILE" geo/GeoLite2-ASN.mmdb
            echo "‚úÖ Updated geo/GeoLite2-ASN.mmdb"
          else
            echo "‚ùå Not found GeoLite2-ASN.mmdb"
            exit 1
          fi

      # 3Ô∏è‚É£ Ê£ÄÊü•ÊòØÂê¶ÊúâÂèòÂåñ
      - name: Check for changes
        id: gitcheck
        run: |
          git add geo
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # 4Ô∏è‚É£ Êèê‰∫§Âπ∂Êé®ÈÄÅ
      - name: Commit and push
        if: steps.gitcheck.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "update: GEO files $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:${{ github.ref }}

      - name: Skip if no changes
        if: steps.gitcheck.outputs.changed == 'false'
        run: echo "‚úÖ No updates detected, skipping commit."
